<!DOCTYPE html><html lang=fr><head><meta charset=utf-8 /><meta content="width=device-width,initial-scale=1" name=viewport /><title>Cron job Amazon EC2 avec Whenever & Mail &bull; Antoine Brisset</title><meta content="Utilisez la puissance d'Amazon EC2 pour vous créer des petites tâches cron et vous facilier le SEO au quotidien. Je vous livre ici un tuto détaillé !" name=description /><meta content="index,follow" name=robots /><meta content=R7aPiADkUTnBNzbTvsqutfN3_gewIxUFwJpKYyc-hBQ name=google-site-verification /><link href="/apple-touch-icon.png" rel=apple-touch-icon sizes=57x57 /><link href="/apple-touch-icon-57x57-precomposed.png" rel=apple-touch-icon sizes=57x57 /><link href="/apple-touch-icon-60x60-precomposed.png" rel=apple-touch-icon sizes=60x60 /><link href="/apple-touch-icon-72x72-precomposed.png" rel=apple-touch-icon sizes=72x72 /><link href="/apple-touch-icon-76x76-precomposed.png" rel=apple-touch-icon sizes=76x76 /><link href="/apple-touch-icon-114x114-precomposed.png" rel=apple-touch-icon sizes=114x114 /><link href="/apple-touch-icon-120x120-precomposed.png" rel=apple-touch-icon sizes=120x120 /><link href="/apple-touch-icon-144x144-precomposed.png" rel=apple-touch-icon sizes=144x144 /><link href="/apple-touch-icon-152x152-precomposed.png" rel=apple-touch-icon sizes=152x152 /><link href="/favicon-196x196.png" rel=icon sizes=196x196 type="image/png"/><link href="/favicon-160x160.png" rel=icon sizes=160x160 type="image/png"/><link href="/favicon-96x96.png" rel=icon sizes=96x96 type="image/png"/><link href="/favicon-32x32.png" rel=icon sizes=32x32 type="image/png"/><link href="/favicon-16x16.png" rel=icon sizes=16x16 type="image/png"/><meta content="#f5f5f5" name=msapplication-TileColor /><meta content="/mstile-144x144.png" name=msapplication-TileImage /><link href="/stylesheets/application.css" rel=stylesheet /><link href="//fonts.googleapis.com/css?family=Open+Sans:400,300,600,700,800" rel=stylesheet /><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel=stylesheet /><style>.header{background-image: url('/images/backgrounds/small/train.jpg');}
    @media screen and (min-width: 25em){.header{background-image: url('/images/backgrounds/medium/train.jpg');}}
    @media screen and (min-width: 50em){.header{background-image: url('/images/backgrounds/train.jpg');}}</style><script src="/javascripts/all.js"></script></head><body class="blog blog_cron-job-whenever blog_cron-job-whenever_index"> <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-WW7MSH" height=0 width=0 style="display:none;visibility:hidden"></iframe></noscript> <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
          new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
          j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
          '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
          })(window,document,'script','dataLayer','GTM-NKG6T7');</script> <div class=wrapper><nav role=navigation><div class=fat-nav><div class=fat-nav__wrapper><ul><li><a href="/">Accueil</a></li><li><a href="/blog/">Blog SEO</a></li><li><a href="/#contact">Contact</a></li></ul></div></div></nav></div><div role=main></div><div class=header><div class=wrapper><h1 class=header__title>Créer une tâche cron SEO avec Whenever, Mail et Amazon EC2</h1><p class=header__category><i class="fa fa-tag"></i> <em>Scripts SEO</em></p></div></div><div class="section section__content--large"><div class=wrapper><article class=blog__article><p class=blog__breadcrumb><a href="/blog/">Blog SEO</a> / <a href="/blog/categories/scripts-seo/">Scripts SEO</a></p><p class=blog__date>Publié le 12 Nov 2013</p><p class=blog__chapo>Quand on bosse le SEO d'un site, on est souvent amené à corriger des petits bugs, bien souvent après qu'ils se soient déclarés. En automatisant certaines tâches, de manière quotidienne ou hebdomadaire, on peut être alerté plus rapidement des éventuels problèmes ou mettre en place un système de monitoring sur certaines données.</p><p>Je vous propose donc ici un exemple de tâche cron vous permettant de suivre au travers d&#39;un mail quotidien le nombre de pages de votre site indexées par Google. Pour ce faire, j&#39;utiliserai les gems <em>Mail</em>, <em>Whenever</em> et <em>Nokogiri</em>. Le script sera lancé depuis une instance Linux d&rsquo;<a href="http://aws.amazon.com/fr/ec2/">Amazon EC2</a>, un des outils cloud de l&#39;offre <strong>AWS</strong> que je ne peux que recommander pour sa souplesse d&#39;utilisation. D&#39;autant qu&#39;EC2 est gratuit pendant un an, à hauteur de 750 heures d&#39;utilisation par mois. Si vous souhaitez installer proprement Ruby et les principaux utilitaires sur votre machine distance, je vous invite à suivre <a href="https://github.com/bvmake/WhosGotWhat/wiki/Installing-Rails-on-free-Amazon-EC2-Micro">ce court tutoriel</a>.</p> <h2>Scraper le nombre de résultats de la commande site:</h2> <p>Pour commencer, il nous faut la méthode qui permettra de scraper le nombre de résultats Google retournés par la commande site:nomdusite.com. Celle-ci prendra en argument une URL, exécutera la requête site:nomdusite.com sur Google.fr et retournera le résultat sous forme de string. Avant de commencer, il faut faire appel aux différentes gems dont on aura besoin.</p> <div class=highlight><pre class="highlight ruby"><code><span class="c1">#!/usr/bin/env ruby</span>

<span class="nb">require</span> <span class="s1">'mail'</span>
<span class="nb">require</span> <span class="s1">'net/http'</span>
<span class="nb">require</span> <span class="s1">'nokogiri'</span>
<span class="nb">require</span> <span class="s1">'open-uri'</span>
<span class="nb">require</span> <span class="s1">'rubygems'</span>
<span class="nb">require</span> <span class="s1">'timeout'</span>
</code></pre></div> <p>Si vous avez installé bundler sur votre serveur Linux, pensez à déclarer ces dépendances dans votre Gemfile et à faire un petit <em>bundle install</em> pour installer les éventuelles gems manquantes.</p> <p>Première chose, on vérifie que l&#39;URL entrée en argument a la bonne syntaxe.</p> <div class=highlight><pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">scrape_google</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">url</span> <span class="o">=~</span> <span class="sr">/^</span><span class="si">#{</span><span class="no">URI</span><span class="o">::</span><span class="n">regexp</span><span class="si">}</span><span class="sr">$/</span>
</code></pre></div> <p>On instancie ensuite la variable &ldquo;indexed_pages&rdquo; qui contiendra nos résultats.</p> <div class=highlight><pre class="highlight ruby"><code>    <span class="n">indexed_pages</span> <span class="o">=</span> <span class="kp">nil</span>
</code></pre></div> <p>Puis on commence le traitement, dans un block <em>begin&hellip;rescue</em>, en fixant un Timeout à 20 secondes pour l&#39;ouverture de la page. Via la gem <em>Nokogiri</em>, dont j&#39;ai déjà parlé <a href="http://www.antoine-brisset.com/blog/ruby-scraping/">ici</a>, on va scraper tout ce qui est contenu dans le XPath correspondant au nombre de résultats affichés par Google, e.g <em>Environ &hellip; résultats (&hellip; secondes)</em></p> <div class=highlight><pre class="highlight ruby"><code>    <span class="k">begin</span>
      <span class="no">Timeout</span><span class="p">.</span><span class="nf">timeout</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">data</span>            <span class="o">=</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">HTML</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">"http://www.google.fr/search?hl=fr&amp;q=site%3A</span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">"</span><span class="p">).</span><span class="nf">read</span><span class="p">,</span> <span class="s2">"UTF-8"</span><span class="p">)</span>
        <span class="n">results</span>         <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">at_xpath</span><span class="p">(</span><span class="s2">"//*[@id=</span><span class="se">\"</span><span class="s2">resultStats</span><span class="se">\"</span><span class="s2">]"</span><span class="p">).</span><span class="nf">text</span>
</code></pre></div> <p>Ensuite, on va rendre plus propre la chaine de caractères</p> <ul> <li>en supprimant le contenu des parenthèses indiquant le temps d&#39;exécution de la requête (via la méthode gsub)</li> <li>en supprimant la sous-chaîne &ldquo;résultats&rdquo;.</li> </ul> <div class=highlight><pre class="highlight ruby"><code>        <span class="n">proper_results</span>  <span class="o">=</span> <span class="n">results</span><span class="p">.</span><span class="nf">downcase</span><span class="p">.</span><span class="nf">gsub</span><span class="p">(</span><span class="sr">/\(.*\)/</span><span class="p">,</span> <span class="s2">""</span><span class="p">).</span><span class="nf">delete</span><span class="p">(</span><span class="s2">"résultats"</span><span class="p">)</span>
        <span class="n">indexed_pages</span>   <span class="o">=</span> <span class="s2">"Nombre de pages indexées : </span><span class="si">#{</span><span class="n">proper_results</span><span class="si">}</span><span class="s2">."</span>
      <span class="k">end</span>
</code></pre></div> <p>En cas d&#39;erreur, on stocke le type d&#39;erreur.</p> <div class=highlight><pre class="highlight ruby"><code>    <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="n">indexed_pages</span> <span class="o">=</span> <span class="s2">"Nombre de pages indexées : </span><span class="si">#{</span><span class="n">e</span><span class="si">}</span><span class="s2">."</span>
    <span class="k">end</span>
</code></pre></div> <p>Si l&#39;URI entrée comme argument n&#39;est pas valide, on renvoie ceci :</p> <div class=highlight><pre class="highlight ruby"><code>  <span class="k">else</span>
    <span class="n">indexed_pages</span> <span class="o">=</span> <span class="s2">"Nombre de pages indexées : </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2"> n'est pas une URL valide."</span>
  <span class="k">end</span>
</code></pre></div> <p>Dans tous les cas, on renvoie la variable &ldquo;indexed_pages&rdquo;, qui sera utilisée comme objet du mail, comme nous allons le voir dans la suite de l&#39;article.</p> <div class=highlight><pre class="highlight ruby"><code>  <span class="k">return</span> <span class="n">indexed_pages</span>
<span class="k">end</span>
</code></pre></div> <h2>Envoyer un mail avec le nombre de résultats</h2> <p>Maintenant que nous avons défini la méthode permettant de stocker le nombre de pages indexées, il faut créer la méthode permettant d&#39;envoyer cette information par mail. La <a href="https://github.com/mikel/mail">gem <em>Mail</em></a> va nous permettre de réaliser cela facilement.</p> <p>Dans l&#39;exemple ci-dessous, j&#39;utilise le smtp de gmail pour l&#39;envoi du mail. Mais si votre sendmail est bien configuré, vous pouvez opter pour celui-ci. Je vous renvoie à la <a href="https://github.com/mikel/mail#sending-an-email">doc</a> pour plus d&#39;explications.</p> <p>On crée un objet un mail avec <em>Mail.new</em> auquel on passe en attributs le destinataire du mail, l&#39;expéditeur, l&#39;objet et, dans le corps du mail, on renvoie à l&#39;objet issu de la méthode scrape_google définie précédemment. Enfin, pour envoyer le mail, on utilise &ldquo;deliver&rdquo;.</p> <div class=highlight><pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">send_mail</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
  <span class="n">mail</span> <span class="o">=</span> <span class="no">Mail</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
    <span class="ss">:to</span>               <span class="o">=&gt;</span> <span class="s1">'toto@gmail.fr'</span><span class="p">,</span>
    <span class="ss">:from</span>             <span class="o">=&gt;</span> <span class="s1">'toto@ec2-amazon.com'</span><span class="p">,</span>
    <span class="ss">:subject</span>          <span class="o">=&gt;</span> <span class="s1">'Résultat de ma tâche cron SEO'</span><span class="p">,</span>
    <span class="ss">:body</span>             <span class="o">=&gt;</span> <span class="s2">"</span><span class="si">#{</span><span class="n">string</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
  <span class="p">)</span>
  <span class="n">mail</span><span class="p">.</span><span class="nf">delivery_method</span> <span class="ss">:smtp</span><span class="p">,{</span>
    <span class="ss">:address</span>          <span class="o">=&gt;</span> <span class="s1">'smtp.gmail.com'</span><span class="p">,</span>
    <span class="ss">:port</span>             <span class="o">=&gt;</span> <span class="s1">'587'</span><span class="p">,</span>
    <span class="ss">:user_name</span>        <span class="o">=&gt;</span> <span class="s1">'votre_user@gmail.com'</span><span class="p">,</span>
    <span class="ss">:password</span>         <span class="o">=&gt;</span> <span class="s1">'votre_mot_de_passe'</span><span class="p">,</span>
    <span class="ss">:authentification</span> <span class="o">=&gt;</span> <span class="s1">':plain'</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="n">mail</span><span class="p">.</span><span class="nf">deliver</span>
<span class="k">end</span>

<span class="n">index</span> <span class="o">=</span> <span class="n">scrape_google</span><span class="p">(</span><span class="s2">"http://www.nomdusite.com"</span><span class="p">)</span>
<span class="n">send_mail</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
</code></pre></div> <h2>Créer la tâche cron</h2> <p>Dernière étape, la création de la tâche cron. Installez tout d&#39;abord la gem <a href="https://github.com/javan/whenever"><em>Whenever</em></a> sur votre instance. Vous pouvez :</p> <ul> <li>l&#39;ajouter dans votre Gemfile de cette façon (et exécuter en console un <em>bundle install</em>)</li> </ul> <div class=highlight><pre class="highlight ruby"><code><span class="n">gem</span> <span class="s1">'whenever'</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="kp">false</span>
</code></pre></div> <ul> <li>ou alors l&#39;installer directement en ligne de commande via &ldquo;gem install whenever&rdquo;.</li> </ul> <p>Dans le dossier où vous avez créé votre script, créez un nouveau dossier /config et ajoutez-y le fichier <strong>schedule.rb</strong> dans lequel vous allez définir votre tâche cron. La syntaxe est simple : il suffit de choisir une fréquence puis de définir quelle commande exécuter.</p> <p>Par exemple, pour exécuter chaque jour à 8h notre script d&#39;envoi de mail, que l&#39;on appelera index.rb, le fichier schedule.rb contiendra les lignes suivantes :</p> <div class=highlight><pre class="highlight ruby"><code><span class="n">every</span> <span class="ss">:day</span><span class="p">,</span> <span class="ss">:at</span> <span class="o">=&gt;</span> <span class="s1">'8:00 am'</span> <span class="k">do</span>
   <span class="n">command</span> <span class="s2">"cd ~/mon_dossier/;ruby index.rb"</span>
<span class="k">end</span>
</code></pre></div> <p>Pour que cette entrée soit ajoutée au crontab, il suffit ensuite dans la console d&#39;exécuter la commande <em>whenever &ndash;update-crontab</em> au niveau du répertoire dans lequel se trouve le script.</p> <p>Et voilà, vous recevrez chaque jour par mail le nombre de pages indexées sur votre site !</p> <div id=disqus_thread></div> <script>
//<![CDATA[
                  var disqus_shortname = 'blogantoinebrisset';
          
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
//]]>
</script> <noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a></noscript> <a href='http://disqus.com' class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a> </article></div></div><footer class=footer><div role=content-info><ul class=footer__content><li class=footer__content__item><i class="fa fa-home"></i> Marquette-lez-Lille</li><li class=footer__content__item><i class="fa fa-phone"></i> 06 12 71 82 78</li><li class=footer__content__item><i class="fa fa-envelope"></i> <a href="#email-protection-pbagnpg@nagbvar-oevffrg.pbz">contact@antoine-brisset.com</a> </li></ul><ul class=footer__content--social><li class=footer__content__item--social><a href="https://twitter.com/abrisset"><i class='fa fa-twitter footer__icon'></i></a></li><li class=footer__content__item--social><a href="https://github.com/ABrisset"><i class='fa fa-github footer__icon'></i></a></li><li class=footer__content__item--social><a href="http://plus.google.com/112811217796192792405?rel=author"><i class='fa fa-google-plus footer__icon'></i></a></li></ul><div class=footer__copyright> &copy; 2019 - <a href="/">Antoine Brisset</a></div></div></footer><script type="text/javascript">!function(){try{var a,b,c,d,g=document.getElementsByTagName("a");for(c=0;g.length-c;c++)try{b=g[c].getAttribute("href"),b&&b.indexOf("#email-protection-")>-1&&b.length>19&&(a="",d=19+b.indexOf("#email-protection-"),b.length>d&&(a=b.substr(18).replace(/[a-zA-Z]/g,function(a){return String.fromCharCode(("Z">=a?90:122)>=(a=a.charCodeAt(0)+13)?a:a-26)})),g[c].setAttribute("href","mailto:"+a))}catch(h){}}catch(h){}}();</script>
</body></html>